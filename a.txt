package com.fd.web.community;


import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.alibaba.dubbo.config.annotation.Reference;
import com.alibaba.fastjson.JSONObject;
import com.fd.common.annotation.ActionMethod;
import com.fd.common.annotation.CurrentUserCached;
import com.fd.common.exception.ExceptionCommunityEnum;
import com.fd.common.result.base.Result;
import com.fd.common.result.base.ResultUtil;
import com.fd.param.PageParam;
import com.fd.provide.community.CommunityUserService;
import com.fd.provide.community.GroupService;
import com.fd.provide.community.PostService;
import com.fd.provide.community.param.PostParam;
import com.fd.provide.community.pojo.GroupObj;
import com.fd.provide.community.pojo.MsgObj;
import com.fd.provide.community.pojo.PostObj;
import com.fd.provide.community.pojo.UserObj;
import com.fd.provide.community.pojo.base.SimpleUser;
import com.fd.provide.user.UserService;
import com.fd.provide.user.pojo.UserInfoObj;

/**
 * 朋友圈接口
 */
@RestController
@RequestMapping("/community")
public class CommunityController {

    private Logger logger = LoggerFactory.getLogger(this.getClass());

    @Reference
    private UserService userService;

    @Reference
    private CommunityUserService communityUserService;

    @Reference
    private PostService postService;

    @Reference
    private GroupService groupService;

    @ActionMethod(serviceName = "1.1 发帖")
    @RequestMapping(value = "/post", method = RequestMethod.POST)
    public Result<?> post(
            @CurrentUserCached UserInfoObj userInfoObj, PostParam param) {
        SimpleUser author = new SimpleUser();

        author.setHeadurl(userInfoObj.getWechatImg());
        author.setName(userInfoObj.getWechatName());
        author.setUserId(userInfoObj.getId());

        PostObj postObj = new PostObj();
        postObj.setAuthor(author);
        postObj.setType(param.getType());
        postObj.setVideourl(param.getVideourl());
        if (StringUtils.isNotEmpty(param.getPictureurl())) {
            List<String> pictureurl = Arrays.asList(param.getPictureurl().split(","));
            postObj.setPictureurl(pictureurl);
        }
        postObj.setPostTime(System.currentTimeMillis());
        postObj.setMsg(param.getMsg());
        // 默认审核通过
        postObj.setState(1);
        postObj.setCommentCount(0);
        postObj.setPraiseCount(0);
        List<Integer> sendMsgUserList = new ArrayList<Integer>();
        sendMsgUserList.add(userInfoObj.getId());
        postObj.setSendMsgUserList(sendMsgUserList);
        try {
            PostObj save = postService.savePost(postObj);
            if (save == null) {
                return ResultUtil.error(ExceptionCommunityEnum.COMMUNITY000001.getCode(),
                        ExceptionCommunityEnum.COMMUNITY000001.getDesc());
            }
        } catch (Exception e) {
            e.printStackTrace();
            return ResultUtil.error(ExceptionCommunityEnum.COMMUNITY000002.getCode(),
                    ExceptionCommunityEnum.COMMUNITY000002.getDesc());
        }
        return ResultUtil.success();
    }

    @ActionMethod(serviceName = "1.2 删除帖子")
    @RequestMapping(value = "/deletePost", method = RequestMethod.POST)
    public Result<?> deletePost(@RequestParam(value = "postId") Integer postId) {
        try {
            int result = postService.deletePost(postId);
            if (result == 0) {
                logger.error("community...deletePost:{}" + "删除帖子失败");
                return ResultUtil.error(ExceptionCommunityEnum.COMMUNITY000003.getCode(),
                        ExceptionCommunityEnum.COMMUNITY000003.getDesc());
            }
        } catch (Exception e) {
            logger.error("community...deletePost:{}" + e.toString());
            return ResultUtil.error(ExceptionCommunityEnum.COMMUNITY000003.getCode(),
                    ExceptionCommunityEnum.COMMUNITY000003.getDesc());
        }
        logger.info("community...deletePost success ");
        return ResultUtil.success();
    }

    @ActionMethod(serviceName = "1.3 社区首页数据")
    @RequestMapping(value = "/home", method = RequestMethod.POST)
    @ResponseBody
    public Object home(@CurrentUserCached UserInfoObj userInfoObj, PageParam pageParam) {
        Map<String, Object> returnMap = new HashMap<String, Object>();
        returnMap.put("code", "Y");
        returnMap.put("msg", "");
        Integer userId = userInfoObj.getId();
        UserObj userObj = communityUserService.queryByUserId(userId);
        if (userObj == null) {
            // 增加用户
            String name = "匿名"; // 昵Q
            String headurl = "";// 头像URL
            try {
                name = userInfoObj.getWechatName() != null ? userInfoObj.getWechatName() : (userInfoObj.getName() != null ? userInfoObj.getName() : name); // 昵Q
                headurl = userInfoObj.getWechatImg() == null ? "" : userInfoObj.getWechatImg();// 头像URL
            } catch (Exception e) {
                e.printStackTrace();
            }
            userObj = new UserObj();
            userObj.setBackPicUrl("");
            userObj.setFollow(new ArrayList<SimpleUser>());
            userObj.setFollowCount(0);
            userObj.setHeadurl(headurl);
            userObj.setMsgList(new ArrayList<MsgObj>());
            userObj.setName(name);
            userObj.setPostCount(0);
            userObj.setUnReadCount(0);
            userObj.setMsgCount(0);
            userObj.setUserId(userId);
            communityUserService.saveOrUpdateUser(userObj);
        }

        // 获取群组列表
        returnMap.put("groupList", getGroupList(userInfoObj));
        // 获取帖子
        List<PostObj> postList = postService.getPostList(null, pageParam.getPageNum(), pageParam.getPageSize());
        //找出用户是否在该帖的点赞列表中
        for (PostObj postObj : postList) {
            for (SimpleUser user : postObj.getPraiseList()) {
                if (user.getUserId() == userId) {
                    postObj.setPraise(true);
                    break;
                }
            }
        }

        returnMap.put("postList", postList);

        returnMap.put("msgObj", new MsgObj());
        List<MsgObj> MsgList = userObj.getMsgList();
        if (MsgList != null && MsgList.size() > 0) {
            MsgObj msgObj = MsgList.get(0);
            returnMap.put("msgObj", msgObj);
        }
        returnMap.put("unReadCount", userObj.getUnReadCount());

        return returnMap;
    }

    /**
     * 获取群组列表
     *
     * @param userInfoObj
     * @return
     */
    private List<GroupObj> getGroupList(UserInfoObj userInfoObj) {
        //每一级别（2.3.4.7）群返回一个未满人的群，如果没有，就创建一个新的群返回
        // 群主的identifier
        String groupIdentifier = groupService.getGroupOwner();
        // 获取sig
        String groupSig = userService.getUserSig(groupIdentifier);
        List<GroupObj> groupList = groupService.getGroupList(groupIdentifier, groupSig, String.valueOf(userInfoObj.getId()), userInfoObj.getUserLevel());
        return groupList;
    }


    @ActionMethod(serviceName = "1.4 点赞（包括取消点赞）")
    @RequestMapping(value = "/praise", method = RequestMethod.POST)
    public Result<?> praise(@CurrentUserCached UserInfoObj userInfoObj, Integer postId, int operType) {
        postService.praise(userInfoObj.getId(), postId, operType);
        return ResultUtil.success();
    }

    /**
     * 1.9 个人中心（先分页返回帖子，关注数）
     *
     * @param userInfoObj 缓存用户数据
     * @param userId      查看用户ID，如果不传就是查看自己的个人中心
     * @param pageNum     页码
     * @param pageSize    页长
     * @return
     */
    @ActionMethod(serviceName = "1.9 个人中心")
    @RequestMapping(value = "/usercenter", method = RequestMethod.POST)
    @ResponseBody
    public Object usercenter(@CurrentUserCached UserInfoObj userInfoObj,
                             Integer userId,
                             @RequestParam(value = "pageNum", defaultValue = "1", required = false) Integer pageNum,
                             @RequestParam(value = "pageSize", defaultValue = "10", required = false) Integer pageSize) {
        logger.info("userInfoObj = [" + userInfoObj + "], userId = [" + userId + "], pageNum = [" + pageNum + "], pageSize = [" + pageSize + "]");
        userId = (userId != null) ? userId : userInfoObj.getId();
        UserObj userObj = communityUserService.queryByUserId(userId);
        List<PostObj> postObjList = postService.getPostList(userId, pageNum, pageSize);
        userObj.setPostObjList(postObjList);

        JSONObject data = new JSONObject();
        data.put("userId", userObj.getUserId());
        data.put("name", userObj.getName());
        data.put("headurl", userObj.getHeadurl());
        data.put("backPicUrl", userObj.getBackPicUrl());
        data.put("postCount", userObj.getPostCount());
        data.put("followCount", userObj.getFollowCount());
        data.put("postObjList", postObjList);
        data.put("hasPostListNext", hasPostListNext(pageNum + 1, pageSize, userId));
        data.put("unReadCount", userObj.getUnReadCount());
        data.put("msgObj", (userObj.getMsgList() == null || userObj.getMsgList().size() == 0) ? new MsgObj() : userObj.getMsgList().get(0));

        Map<String, Object> returnMap = new HashMap<String, Object>();
        returnMap.put("code", "Y");
        returnMap.put("msg", "");
        returnMap.put("data", data);
        return returnMap;
    }

    private boolean hasPostListNext(int pageNum, int pageSize, Integer userId) {
        List<PostObj> list = postService.getPostList(userId, pageNum, pageSize);
        return list != null && !list.isEmpty();
    }

    @ActionMethod(serviceName = "1.5.1 评论帖子")
    @RequestMapping(value = "/commentPost", method = RequestMethod.POST)
    public Result<?> commentPost(@CurrentUserCached UserInfoObj userInfoObj,
                                 @RequestParam(value = "postId") Integer postId,
                                 @RequestParam(value = "msg", required = false) String msg) {
        logger.info("community...commentPost begin ");

        try {
            SimpleUser simpleUser = new SimpleUser();
            simpleUser.setHeadurl(userInfoObj.getWechatImg());
            simpleUser.setName(userInfoObj.getWechatName());
            simpleUser.setUserId(userInfoObj.getId());

            int result = postService.commentPost(postId, simpleUser, msg);
            if (result == 0) {
                logger.error("community...commentPost:{}" + "评论帖子失败");
                return ResultUtil.error(ExceptionCommunityEnum.COMMUNITY000003.getCode(),
                        ExceptionCommunityEnum.COMMUNITY000003.getDesc());
            }
        } catch (Exception e) {
            logger.error("community...commentPost:{}" + e.toString());
            return ResultUtil.error(ExceptionCommunityEnum.COMMUNITY000003.getCode(),
                    ExceptionCommunityEnum.COMMUNITY000003.getDesc());
        }
        logger.info("community...commentPost success ");
        return ResultUtil.success();
    }

    @ActionMethod(serviceName = "1.5.2 回复评论")
    @RequestMapping(value = "/replyComment", method = RequestMethod.POST)
    public Result<?> replyComment() {
        return ResultUtil.success();
    }

    @ActionMethod(serviceName = "1.9.1 个人中心分页返回帖子")
    @RequestMapping(value = "/usercenter/post", method = RequestMethod.POST)
    public Result<?> usercenterPost(@CurrentUserCached UserInfoObj userInfoObj, Integer userId, int pageNum, int pageSize) {
        logger.info("1.9.1 个人中心分页返回帖子");
        logger.info("userInfoObj = [" + userInfoObj + "], userId = [" + userId + "], pageNum = [" + pageNum + "], pageSize = [" + pageSize + "]");
        if (userId == null) {
            userId = userInfoObj.getId();
        }
        List<PostObj> userList = postService.getPostList(userId, pageNum, pageSize);
        return ResultUtil.success(userList);
    }

    @ActionMethod(serviceName = "1.9.2 个人中心分页返回关注")
    @RequestMapping(value = "/usercenter/follow", method = RequestMethod.POST)
    public Result<?> usercenterFollow(@CurrentUserCached UserInfoObj userInfoObj, Integer userId, int pageNum, int pageSize, String name) {
        logger.info("1.9.2 个人中心分页返回关注");
        logger.info("userInfoObj = [" + userInfoObj + "], userId = [" + userId + "], pageNum = [" + pageNum + "], pageSize = [" + pageSize + "], name = [" + name + "]");
        if (userId == null) {
            userId = userInfoObj.getId();
        }
        if (StringUtils.isEmpty(name)) {
            name = "";
        }
        List<SimpleUser> userList = communityUserService.usercenterFollow(userId, pageNum, pageSize, name);
        return ResultUtil.success(userList);
    }

    @ActionMethod(serviceName = "1.6 获取帖子详情")
    @RequestMapping(value = "/postDesc", method = RequestMethod.POST)
    public Result<?> postDesc(int postId) {
        PostObj postObj = postService.detail(postId);
        if (postObj == null) {
            return ResultUtil.error(ExceptionCommunityEnum.COMMUNITY000005.getCode(),
                    ExceptionCommunityEnum.COMMUNITY000005.getDesc());
        }
        return ResultUtil.success(postObj);
    }
    
     @ActionMethod(serviceName = "1.12 关注/取消关注")
    @RequestMapping(value = "/follow", method = RequestMethod.POST)
    public Result<?> followNew(@CurrentUserCached UserInfoObj userInfoObj, Integer userId, int type) {
        communityUserService.followNew(userInfoObj.getId(), userId, type);
        return ResultUtil.success();
    }

    @ActionMethod(serviceName = "1.12 关注/取消关注")
    @RequestMapping(value = "/follow", method = RequestMethod.POST)
    public Result<?> follow(@CurrentUserCached UserInfoObj userInfoObj, Integer userId, int type) {
        communityUserService.follow(userInfoObj.getId(), userId, type);
        return ResultUtil.success();
    }

    @ActionMethod(serviceName = "1.7 分页获取消息")
    @RequestMapping(value = "/msgList", method = RequestMethod.POST)
    @ResponseBody
    public Object msg(@CurrentUserCached UserInfoObj userInfoObj, PageParam pageParam) {
        //分页获取消息，注意，这个列表应该是倒序排列的，在插入数据的时候。 返回数据之前，把用户的unReadCount设置为0, 还有消息体的unRead设置false 已读
        List<MsgObj> msgList = communityUserService.getUserMsgList(userInfoObj.getId(), pageParam.getPageSize(), pageParam.getPageNum());
        List<MsgObj> temp = communityUserService.getUserMsgList(userInfoObj.getId(), pageParam.getPageSize(), pageParam.getPageNum() + 1);
        boolean hasNext = temp != null && !temp.isEmpty();
        Map<String, Object> returnMap = new HashMap<String, Object>();
        returnMap.put("code", "Y");
        returnMap.put("msg", "");
        // 获取消息列表
        returnMap.put("msgList", msgList);
        returnMap.put("hasNext", hasNext);
        return returnMap;
    }

    @ActionMethod(serviceName = "1.7.1 清空消息")
    @RequestMapping(value = "/clearMsgList", method = RequestMethod.POST)
    @ResponseBody
    public Object clearMsgList(@CurrentUserCached UserInfoObj userInfoObj) {
        UserObj userObj = communityUserService.queryByUserId(userInfoObj.getId());
        userObj.setMsgList(new ArrayList<MsgObj>());
        communityUserService.saveOrUpdateUser(userObj);
        return ResultUtil.success();
    }
    
     @ActionMethod(serviceName = "1.12 关注/取消关注")
    @RequestMapping(value = "/follow", method = RequestMethod.POST)
    public Result<?> followNew(@CurrentUserCached UserInfoObj userInfoObj, Integer userId, int type) {
        communityUserService.followNew(userInfoObj.getId(), userId, type);
        return ResultUtil.success();
    }


}

